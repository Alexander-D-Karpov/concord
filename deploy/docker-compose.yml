services:
  postgres:
    image: postgres:14-alpine
    restart: always
    env_file:
      - ../.env
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-concord}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: always
    env_file:
      - ../.env
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.api
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - ../.env
    environment:
      - DB_HOST=postgres
      - REDIS_HOST=redis
      - SERVER_PORT=${SERVER_PORT:-8080}
      - GRPC_PORT=${GRPC_PORT:-9000}
      - REGISTRY_URL=localhost:${GRPC_PORT:-9000}
    ports:
      - "${SERVER_PORT:-8080}:${SERVER_PORT:-8080}" # REST
      - "${GRPC_PORT:-9000}:${GRPC_PORT:-9000}"     # gRPC
      - "${METRICS_PORT:-9100}:${METRICS_PORT:-9100}" # Metrics
      - "${HEALTH_PORT:-8081}:${HEALTH_PORT:-8081}"   # Health

  voice:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.voice
    restart: always
    depends_on:
      api:
        condition: service_started
    env_file:
      - ../.env
    environment:
      - REGISTRY_URL=api:${GRPC_PORT:-9000}
      - VOICE_CONTROL_PORT=${VOICE_CONTROL_PORT:-9001}
      - VOICE_METRICS_PORT=${VOICE_METRICS_PORT:-9101}
      - VOICE_HEALTH_PORT=${VOICE_HEALTH_PORT:-8082}
      # Voice needs to know its public IP (host) for the client to connect via UDP
      # In dev, this is 127.0.0.1. In prod, set VOICE_PUBLIC_HOST in .env
      - VOICE_PUBLIC_HOST=${VOICE_PUBLIC_HOST:-127.0.0.1}
    ports:
      - "${VOICE_CONTROL_PORT:-9001}:${VOICE_CONTROL_PORT:-9001}"
      - "${VOICE_UDP_PORT_START:-50000}-${VOICE_UDP_PORT_END:-50100}:${VOICE_UDP_PORT_START:-50000}-${VOICE_UDP_PORT_END:-50100}/udp"
      - "${VOICE_METRICS_PORT:-9101}:${VOICE_METRICS_PORT:-9101}"
      - "${VOICE_HEALTH_PORT:-8082}:${VOICE_HEALTH_PORT:-8082}"

volumes:
  postgres_data: